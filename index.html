<!doctype html>
<html ng-app="app">
<head>
    <meta charset="utf-8" /> 
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <title>Spades</title>
</head>
<body>

    <div ng-controller="GameCtrl">
    
        <div ng-repeat="c in go.game.cards">Card: {{c}}</div>
    
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.2.16/angular.min.js"></script>
    <script src="https://cdn.goinstant.net/v1/platform.min.js"></script>
    <script src="https://cdn.goinstant.net/integrations/goangular/latest/goangular.min.js"></script>
    <script>
        angular.module('app', ['goangular'])
        
            .config(function($goConnectionProvider, $locationProvider){
                $locationProvider.html5Mode(true);
                $goConnectionProvider.$set('https://goinstant.net/781fb4c3de1f/spades');
            })
            
            .factory('go', function($goKey, $goConnection, $location, $q){
                var d = $q.defer();
                var go = {
                    ready: d.promise,
                    game: null,
                    user: null
                };
            
                $goConnection.$ready().then(function(connection) {
                    var q = $location.search();
                    return connection.room(q.r || 'test').join();
                }).then(function(joined){
                    var game = $goKey('game', joined.room.name);
                    game.$sync();
                    
                    game.$on('ready', function(){
                        go.game = game;
                        go.user = joined.user;
                        go.room = joined.room;
                        d.resolve();
                    });
                });

                return go;
            })
        
            .controller('GameCtrl', function($scope, go, $interval){
                $scope.go = go;
                
                go.ready.then(function(){
                    go.game.$key('cards').$add(((Math.random()*13)<<0) + ' of spades');
                });
            })
        
        ;
    </script>

</body>
</html>
